\hypertarget{_lua_script_engine_8cpp_source}{}\doxysection{Lua\+Script\+Engine.\+cpp}
\label{_lua_script_engine_8cpp_source}\index{Source/LuaScriptEngine.cpp@{Source/LuaScriptEngine.cpp}}
\mbox{\hyperlink{_lua_script_engine_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00001}00001 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_lua_script_engine_8hpp}{LuaScriptEngine.hpp}}"{}}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00002}00002 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00003}00003 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_lua_script_8hpp}{LuaScript.hpp}}"{}}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00004}00004 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_lua_script_queue_8hpp}{LuaScriptQueue.hpp}}"{}}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00005}00005 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_lua_context_manager_8hpp}{LuaContextManager.hpp}}"{}}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00006}00006 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_lua_functions_8hpp}{LuaFunctions.hpp}}"{}}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00007}00007 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00008}00008 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_logger_8hpp}{Logger.hpp}}"{}}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00009}00009 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00010}00010 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespace_b_a_r_e2_d}{BARE2D}} \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00011}00011 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00012}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_aa8ed4ea17af538a41e8d4fec0727f852}{00012}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_aa8ed4ea17af538a41e8d4fec0727f852}{LuaScriptEngine::LuaScriptEngine}}()}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00013}00013     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00014}00014     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00015}00015 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00016}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a6f0bef2c7ef75d6d28e76403ff8d06c4}{00016}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a6f0bef2c7ef75d6d28e76403ff8d06c4}{LuaScriptEngine::\string~LuaScriptEngine}}()}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00017}00017     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00018}00018         \textcolor{comment}{// Lua automatically garbage collects.}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00019}00019     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00020}00020 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00021}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_afc202ede3bcd76cf0d38a5cfa6da2e86}{00021}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_afc202ede3bcd76cf0d38a5cfa6da2e86}{LuaScriptEngine::init}}(std::string luaModulesPath)}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00022}00022     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00023}00023         \textcolor{comment}{// Create the master state}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00024}00024         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}} = luaL\_newstate();}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00025}00025         }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00026}00026         \textcolor{comment}{// now load all the standard Lua libraries for the master state}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00027}00027         luaL\_openlibs(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}});}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00028}00028         }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00029}00029         \textcolor{comment}{// Set the package.path variable for Lua so that extra user-\/created modules can be loaded in.}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00030}00030         \textcolor{comment}{// Put the global variable's name on the stack}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00031}00031         lua\_getglobal(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, \textcolor{stringliteral}{"{}package"{}});}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00032}00032         \textcolor{comment}{// Push the path identifier for any and all modules}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00033}00033         lua\_pushstring(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, std::string(luaModulesPath + \textcolor{stringliteral}{"{}/?.lua"{}}).c\_str());}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00034}00034         \textcolor{comment}{// Now set package**.path** instead of just package (combines items on the stack, popping the value -\/ the path in this case)}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00035}00035         lua\_setfield(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, -\/2, \textcolor{stringliteral}{"{}path"{}});}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00036}00036         \textcolor{comment}{// Clean up, popping the whole item.}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00037}00037         lua\_pop(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, 1);}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00038}00038         }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00039}00039         \textcolor{comment}{// register the delay() function.}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00040}00040         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_ae207fae3de0b49158c4eeede0e41b070}{registerCFunction}}(\mbox{\hyperlink{namespace_b_a_r_e2_d_1_1_lua_functions_af922bcf60ccf9143297286e148d6968f}{LuaFunctions::delay}}, \textcolor{stringliteral}{"{}delay"{}});}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00041}00041         \textcolor{comment}{// register the print() function}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00042}00042         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_ae207fae3de0b49158c4eeede0e41b070}{registerCFunction}}(\mbox{\hyperlink{namespace_b_a_r_e2_d_1_1_lua_functions_accb5722153e602b5cbb4082f1541c112}{LuaFunctions::print}}, \textcolor{stringliteral}{"{}print"{}});}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00043}00043     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00044}00044 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00045}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_ae9539fd6e864b66bcb00299f24f0c8bc}{00045}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_ae9539fd6e864b66bcb00299f24f0c8bc}{LuaScriptEngine::registerModule}}(std::string filename)}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00046}00046     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00047}00047         \mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{throwError}}(\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15abcb313a5c9f8965d7b75833af33d16be}{BAREError::UNINITIALIZED\_FUNCTION}}, \textcolor{stringliteral}{"{}LuaScriptEngine::registerModule"{}});}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00048}00048     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00049}00049 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00050}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_ae207fae3de0b49158c4eeede0e41b070}{00050}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_ae207fae3de0b49158c4eeede0e41b070}{LuaScriptEngine::registerCFunction}}(lua\_CFunction function, std::string name)}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00051}00051     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00052}00052         \textcolor{comment}{// Needs to add a C-\/function to the masterState}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00053}00053         \textcolor{comment}{// Push the function to the stack with no closure variables (this is equivalent to lua\_pushcclosure(L, func, 0) as stated in the docs}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00054}00054         lua\_pushcfunction(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, function);}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00055}00055         \textcolor{comment}{// Pop the function from the stack and create a global with name `name`}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00056}00056         lua\_setglobal(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, name.c\_str());}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00057}00057     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00058}00058     }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00059}00059     \textcolor{comment}{// addValueToRegistry is defined in the LuaScriptEngine\_impl.tcc template file.}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00060}00060 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00061}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a428a4f2b3f87f8b90db2880a67ffee31}{00061}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a428a4f2b3f87f8b90db2880a67ffee31}{LuaScriptEngine::update}}()}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00062}00062     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00063}00063         \textcolor{comment}{// First, update all the contexts which are already running}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00064}00064         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_context_manager_a0352be9754f64024631091f1e2b73c15}{LuaContextManager::getInstance}}()-\/>\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_context_manager_a5d5afd3c292c652399de872b7d2781da}{update}}();}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00065}00065         }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00066}00066         \textcolor{comment}{// Second, convert all new LuaScripts on the queue to LuaContextWrappers}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00067}00067         \textcolor{comment}{// Use a for each loop because we're fancy like that}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00068}00068         \textcolor{keywordflow}{for}(std::pair<unsigned int, LuaScript*> e : \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_queue_ab2db531a9ecaa50fba9f27715124d948}{LuaScriptQueue::getInstance}}()-\/>getQueue()) \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00069}00069             \textcolor{comment}{// Create the new context wrapper jazz for a new script to run in}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00070}00070             \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}* context = \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a81e4604bf36c490f713d00cd68d4a874}{createLuaContext}}(e.second);}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00071}00071             }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00072}00072             \textcolor{comment}{// Activate it}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00073}00073             context-\/>\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9e06de29f55ec9014c21ae0c22b86297}{start}}();}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00074}00074             }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00075}00075             \textcolor{comment}{// Throw it on into the context manager with the ID given before (that's the e.first part.)}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00076}00076             \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_context_manager_a0352be9754f64024631091f1e2b73c15}{LuaContextManager::getInstance}}()-\/>\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_context_manager_ae5cd0d9c17a813a06fb0f5e8b702f06d}{addContext}}(e.first, context);}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00077}00077         \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00078}00078         \textcolor{comment}{// Clear the queue -\/ we've activated all the scripts}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00079}00079         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_queue_ab2db531a9ecaa50fba9f27715124d948}{LuaScriptQueue::getInstance}}()-\/>\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_queue_a45b878abc0f5e6e91af7b88c7bae81c2}{clearQueue}}();}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00080}00080     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00081}00081 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00082}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a81e4604bf36c490f713d00cd68d4a874}{00082}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}* \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a81e4604bf36c490f713d00cd68d4a874}{LuaScriptEngine::createLuaContext}}(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script}{LuaScript}}* script)}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00083}00083     \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00084}00084         \textcolor{comment}{// Allocate the memory for a new one}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00085}00085         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}* context = \textcolor{keyword}{new} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}();}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00086}00086         \textcolor{comment}{// Actually initialize it.}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00087}00087         context-\/>\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae928c82fc3a9d2b72e0b01caf02a5bbb}{init}}(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}}, script);}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00088}00088         }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00089}00089         \textcolor{keywordflow}{return} context;}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00090}00090     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00091}00091     }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00092}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a3f35a7b4086aa2c2587c133edd0d05c2}{00092}}     lua\_State* \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_a3f35a7b4086aa2c2587c133edd0d05c2}{LuaScriptEngine::getMasterState}}() \{}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00093}00093         \textcolor{keywordflow}{return} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_engine_adb96773e404afca7b5a77a98bda110d8}{m\_masterState}};}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00094}00094     \}}
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00095}00095 }
\DoxyCodeLine{\Hypertarget{_lua_script_engine_8cpp_source_l00096}00096 \}}

\end{DoxyCode}
