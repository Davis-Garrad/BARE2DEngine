\hypertarget{_lua_script_8cpp_source}{}\doxysection{Lua\+Script.\+cpp}
\label{_lua_script_8cpp_source}\index{Source/LuaScript.cpp@{Source/LuaScript.cpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001 \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include} \mbox{\hyperlink{_lua_script_8hpp}{"LuaScript.hpp"}}}
\DoxyCodeLine{00002 }
\DoxyCodeLine{00003 \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include} \mbox{\hyperlink{_b_a_r_e_errors_8hpp}{"BAREErrors.hpp"}}}
\DoxyCodeLine{00004 }
\DoxyCodeLine{00005 \textcolor{preprocessor}{\#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{lua5}\textcolor{preprocessor}{.3}\textcolor{preprocessor}{/}\textcolor{preprocessor}{lua}\textcolor{preprocessor}{.}\textcolor{preprocessor}{hpp}\textcolor{preprocessor}{>}}
\DoxyCodeLine{00006 }
\DoxyCodeLine{00007 \textcolor{keyword}{namespace} \mbox{\hyperlink{namespace_b_a_r_e2_d}{BARE2D}} \{}
\DoxyCodeLine{00008 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00009}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_a5686214d11e32bc31da1f7166b437b80}{00009}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script}{LuaScript}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_a5686214d11e32bc31da1f7166b437b80}{LuaScript}}() \{}
\DoxyCodeLine{00010     \}}
\DoxyCodeLine{00011 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00012}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_acf6a9e39afc2d8ba68649610b9155841}{00012}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script}{LuaScript}}::\string~\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_acf6a9e39afc2d8ba68649610b9155841}{LuaScript}}() \{}
\DoxyCodeLine{00013     \}}
\DoxyCodeLine{00014 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00015}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae0af32134c3684ef955f2143db707a22}{00015}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae0af32134c3684ef955f2143db707a22}{LuaScriptContextWrapper}}() \{}
\DoxyCodeLine{00016     \}}
\DoxyCodeLine{00017 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00018}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a6e8344724ee86168c554f20d373fe2cb}{00018}}     \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\string~\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a6e8344724ee86168c554f20d373fe2cb}{LuaScriptContextWrapper}}() \{}
\DoxyCodeLine{00019     \}}
\DoxyCodeLine{00020 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00021}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae928c82fc3a9d2b72e0b01caf02a5bbb}{00021}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae928c82fc3a9d2b72e0b01caf02a5bbb}{init}}(lua\_State* parentState, \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script}{LuaScript}}* script) \{}
\DoxyCodeLine{00022         \textcolor{comment}{// Set the parent state.}}
\DoxyCodeLine{00023         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abca1c61643424fc2be8f97bfde0e8756}{m\_parent}} = parentState;}
\DoxyCodeLine{00024 }
\DoxyCodeLine{00025         \textcolor{comment}{// Create the self's state, which is actually just a subroutine of the main.}}
\DoxyCodeLine{00026         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab373f9b638c401a70a31a599349d81b7}{createThread}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab373f9b638c401a70a31a599349d81b7}{(}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab373f9b638c401a70a31a599349d81b7}{)}};}
\DoxyCodeLine{00027 }
\DoxyCodeLine{00028         \textcolor{comment}{// Load and compile the script, saving it for later.}}
\DoxyCodeLine{00029         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abf423ac350b4eadd0dbb2679f2b09683}{loadLua}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abf423ac350b4eadd0dbb2679f2b09683}{(}}script\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_a1995fc1d69d00731e44a4525542e4f2f}{-\/>}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_a1995fc1d69d00731e44a4525542e4f2f}{m\_script}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abf423ac350b4eadd0dbb2679f2b09683}{)}};}
\DoxyCodeLine{00030     \}}
\DoxyCodeLine{00031 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00032}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab373f9b638c401a70a31a599349d81b7}{00032}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab373f9b638c401a70a31a599349d81b7}{createThread}}() \{}
\DoxyCodeLine{00033         \textcolor{comment}{// Create the thread, as a subroutine of the parent -\/ the master state/thread.}}
\DoxyCodeLine{00034         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}} = lua\_newthread(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abca1c61643424fc2be8f97bfde0e8756}{m\_parent}});}
\DoxyCodeLine{00035         \textcolor{comment}{// Push the state to the registry of the parent, and return the index}}
\DoxyCodeLine{00036         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a2ec6e655e96ebec57235620024b9f6a5}{m\_threadReference}} = luaL\_ref(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abca1c61643424fc2be8f97bfde0e8756}{m\_parent}}, LUA\_REGISTRYINDEX);}
\DoxyCodeLine{00037 }
\DoxyCodeLine{00038         \textcolor{comment}{// Make sure that we have no errors.}}
\DoxyCodeLine{00039         \textcolor{keywordflow}{if}(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a2ec6e655e96ebec57235620024b9f6a5}{m\_threadReference}} == LUA\_REFNIL) \{}
\DoxyCodeLine{00040             \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}} = \textcolor{keywordtype}{nullptr};}
\DoxyCodeLine{00041             \mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{throwError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{(}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15}{BAREError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{::}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{LUA\_FAILURE}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{,}} \textcolor{stringliteral}{"Failed to create Lua thread"}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{)}};}
\DoxyCodeLine{00042         \}}
\DoxyCodeLine{00043     \}}
\DoxyCodeLine{00044 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00045}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9707c51bc4e1d9b3f5b827c79f3678a4}{00045}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9707c51bc4e1d9b3f5b827c79f3678a4}{destroy}}() \{}
\DoxyCodeLine{00046         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_adbedabb1bef4b251dfea089d2da0edf4}{m\_completed}} = \textcolor{keyword}{true};}
\DoxyCodeLine{00047         \textcolor{keywordflow}{if}(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}) \{}
\DoxyCodeLine{00048             \textcolor{comment}{// Clean the stack}}
\DoxyCodeLine{00049             lua\_settop(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, 0);}
\DoxyCodeLine{00050             \textcolor{comment}{// close and clean the thread}}
\DoxyCodeLine{00051             lua\_close(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}});}
\DoxyCodeLine{00052             \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}} = \textcolor{keywordtype}{nullptr};}
\DoxyCodeLine{00053         \}}
\DoxyCodeLine{00054     \}}
\DoxyCodeLine{00055 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00056}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9e06de29f55ec9014c21ae0c22b86297}{00056}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9e06de29f55ec9014c21ae0c22b86297}{start}}() \{}
\DoxyCodeLine{00057         \textcolor{comment}{// To start a Lua script, we need to call lua\_callk to allow yielding.}}
\DoxyCodeLine{00058 }
\DoxyCodeLine{00059         \textcolor{comment}{// First, to call lua\_callk, we need to push the function (which we earlier stored in the registry) to the stack.}}
\DoxyCodeLine{00060         \textcolor{comment}{// Adds registry[m\_scriptReference] to the stack.}}
\DoxyCodeLine{00061         lua\_rawgeti(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, LUA\_REGISTRYINDEX, \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a685f7bdce2eaa0e532b3b669350654d9}{m\_scriptReference}});}
\DoxyCodeLine{00062 }
\DoxyCodeLine{00063         \textcolor{comment}{// Then push arguments (of which there are none because it's just an entire script)}}
\DoxyCodeLine{00064 }
\DoxyCodeLine{00065         \textcolor{comment}{// Now actually call the function, starting the script.}}
\DoxyCodeLine{00066         \textcolor{keywordtype}{int} nargs = 0;}
\DoxyCodeLine{00067         \textcolor{comment}{// This actually runs the script as a coroutine, so it can be yielded, etc.}}
\DoxyCodeLine{00068         \textcolor{keywordtype}{int} errorCode = lua\_resume(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, \textcolor{keywordtype}{nullptr}, nargs);}
\DoxyCodeLine{00069 }
\DoxyCodeLine{00070         \textcolor{comment}{// Check if there were any errors}}
\DoxyCodeLine{00071         \textcolor{keywordflow}{if}(errorCode != LUA\_OK \&\& errorCode != LUA\_YIELD) \{}
\DoxyCodeLine{00072             \textcolor{comment}{// There is some error. Throw, and use lua\_tostring to get the error string.}}
\DoxyCodeLine{00073             \mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{throwError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{(}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15}{BAREError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{::}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{LUA\_FAILURE}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{,}}}
\DoxyCodeLine{00074                        \textcolor{stringliteral}{"Failed to run Lua script: Lua reports: Error code "} + std::to\_string(errorCode) + \textcolor{stringliteral}{" -\/ \(\backslash\)'"} +}
\DoxyCodeLine{00075                            lua\_tostring(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, -\/1)\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{)}};}
\DoxyCodeLine{00076             \textcolor{keywordflow}{return}; \textcolor{comment}{// we're done here.}}
\DoxyCodeLine{00077         \}}
\DoxyCodeLine{00078     \}}
\DoxyCodeLine{00079 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00080}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab7621231b56bdf66af3ebd1472fca721}{00080}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ab7621231b56bdf66af3ebd1472fca721}{update}}() \{}
\DoxyCodeLine{00081         \textcolor{comment}{// Check if the function is already being delayed}}
\DoxyCodeLine{00082         \textcolor{keywordflow}{if}(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae3fe1bea17dbc1d92540d0c73daac702}{m\_yielded}}) \{}
\DoxyCodeLine{00083             \textcolor{comment}{// Check if there's still a delay left or if we should resume.}}
\DoxyCodeLine{00084             \textcolor{keywordflow}{if}(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a52e40f918a04dcb189d8f2b81a2ef534}{m\_remainingDelay}} <= 0) \{}
\DoxyCodeLine{00085                 \textcolor{comment}{// No delay left, set flags to false and resume}}
\DoxyCodeLine{00086                 \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae3fe1bea17dbc1d92540d0c73daac702}{m\_yielded}} = \textcolor{keyword}{false};}
\DoxyCodeLine{00087                 \textcolor{comment}{// Because there was no true "coroutine," it is okay to pass nullptr as the "from" parameter.}}
\DoxyCodeLine{00088                 \textcolor{comment}{// Otherwise, resumes the script and replaces exactly 0 things on the stack.}}
\DoxyCodeLine{00089                 lua\_resume(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, \textcolor{keywordtype}{nullptr}, 0);}
\DoxyCodeLine{00090             \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00091                 \textcolor{comment}{// If we still have delay left, just decrement.}}
\DoxyCodeLine{00092                 \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a52e40f918a04dcb189d8f2b81a2ef534}{m\_remainingDelay}}-\/-\/;}
\DoxyCodeLine{00093             \}}
\DoxyCodeLine{00094         \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{00095             \textcolor{comment}{// The function is not yielded (!)as far as we know(!)}}
\DoxyCodeLine{00096             \textcolor{comment}{// Check to make sure of this}}
\DoxyCodeLine{00097             \textcolor{keywordtype}{int} status = lua\_status(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}});}
\DoxyCodeLine{00098 }
\DoxyCodeLine{00099             \textcolor{comment}{// May as well check for errors}}
\DoxyCodeLine{00100             \textcolor{keywordflow}{if}(status != LUA\_OK \&\& status != LUA\_YIELD) \{}
\DoxyCodeLine{00101                 \textcolor{comment}{// Error occurred!}}
\DoxyCodeLine{00102                 \mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{throwError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{(}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15}{BAREError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{::}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{LUA\_FAILURE}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{,}} \textcolor{stringliteral}{"Lua script crashed partway through!"}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{)}};}
\DoxyCodeLine{00103                 \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9707c51bc4e1d9b3f5b827c79f3678a4}{destroy}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9707c51bc4e1d9b3f5b827c79f3678a4}{(}}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a9707c51bc4e1d9b3f5b827c79f3678a4}{)}};}
\DoxyCodeLine{00104                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{00105             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(status == LUA\_YIELD) \{}
\DoxyCodeLine{00106                 \textcolor{comment}{// If the status is LUA\_YIELD, then its obviously yielded. Obviously the C-\/side of things doesn't know this yet}}
\DoxyCodeLine{00107                 \textcolor{comment}{// So set the stuff we needed to.}}
\DoxyCodeLine{00108                 \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_ae3fe1bea17dbc1d92540d0c73daac702}{m\_yielded}} = \textcolor{keyword}{true};}
\DoxyCodeLine{00109                 \textcolor{comment}{// Get the first thing on the stack -\/ the delay() variable.}}
\DoxyCodeLine{00110                 \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a52e40f918a04dcb189d8f2b81a2ef534}{m\_remainingDelay}} = lua\_tointeger(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, -\/1);}
\DoxyCodeLine{00111                 \textcolor{comment}{// And remove from the stack.}}
\DoxyCodeLine{00112                 lua\_pop(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, 1);}
\DoxyCodeLine{00113             \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(status == LUA\_OK) \{}
\DoxyCodeLine{00114                 \textcolor{comment}{// This means that the thread is completed}}
\DoxyCodeLine{00115                 \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_adbedabb1bef4b251dfea089d2da0edf4}{m\_completed}} = \textcolor{keyword}{true};}
\DoxyCodeLine{00116             \}}
\DoxyCodeLine{00117         \}}
\DoxyCodeLine{00118     \}}
\DoxyCodeLine{00119 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00120}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abf423ac350b4eadd0dbb2679f2b09683}{00120}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_abf423ac350b4eadd0dbb2679f2b09683}{loadLua}}(std::string\& luaStr) \{}
\DoxyCodeLine{00121         \textcolor{comment}{// Load the string and collect any error code. Note that this loads the script and pushes it to the stack.}}
\DoxyCodeLine{00122         \textcolor{keywordtype}{int} errorCode = luaL\_loadstring(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, (\textcolor{keywordtype}{char}*)luaStr.c\_str());}
\DoxyCodeLine{00123 }
\DoxyCodeLine{00124         \textcolor{comment}{// Check the error.}}
\DoxyCodeLine{00125         \textcolor{keywordflow}{if}(errorCode != LUA\_OK) \{}
\DoxyCodeLine{00126             \textcolor{comment}{// There is some error. Throw, and use lua\_tostring to get the error string.}}
\DoxyCodeLine{00127             \mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{throwError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{(}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15}{BAREError}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{::}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a598d6ee5637b8d61de038646a6674f15aad2cd518718daed8ec4f62c96c4100ba}{LUA\_FAILURE}}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{,}}}
\DoxyCodeLine{00128                        \textcolor{stringliteral}{"Failed to compile Lua string: Lua reports: Error code "} + std::to\_string(errorCode) + \textcolor{stringliteral}{" -\/ \(\backslash\)'"} +}
\DoxyCodeLine{00129                            lua\_tostring(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, -\/1) + \textcolor{stringliteral}{"\(\backslash\)'\(\backslash\)n\(\backslash\)n"} + luaStr + \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)n"}\mbox{\hyperlink{namespace_b_a_r_e2_d_a0d8f8a98bf559e6d2eda28ae744f486c}{)}};}
\DoxyCodeLine{00130             \textcolor{comment}{// At this point it makes no sense to set the script reference, as the script... doesn't exist.}}
\DoxyCodeLine{00131             \textcolor{keywordflow}{return}; \textcolor{comment}{// we're done here.}}
\DoxyCodeLine{00132         \}}
\DoxyCodeLine{00133 }
\DoxyCodeLine{00134         \textcolor{comment}{// Now that we've loaded and compiled the script, we need to push it to the registry.}}
\DoxyCodeLine{00135         \textcolor{comment}{// This is a short form of popping from the stack, storing it in the registry, and returning the key.}}
\DoxyCodeLine{00136         \textcolor{keywordtype}{int} reference = luaL\_ref(\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a78351a99305b579c07feae8a088fbc91}{m\_state}}, LUA\_REGISTRYINDEX);}
\DoxyCodeLine{00137         \textcolor{comment}{// Set the reference to the index in the registry.}}
\DoxyCodeLine{00138         \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a685f7bdce2eaa0e532b3b669350654d9}{m\_scriptReference}} = reference;}
\DoxyCodeLine{00139     \}}
\DoxyCodeLine{00140 }
\DoxyCodeLine{\Hypertarget{_lua_script_8cpp_source_l00141}\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a2e8c9291b16d4be7866251ea60282720}{00141}}     \textcolor{keywordtype}{bool} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper}{LuaScriptContextWrapper}}::\mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_a2e8c9291b16d4be7866251ea60282720}{isCompleted}}() \{}
\DoxyCodeLine{00142         \textcolor{keywordflow}{return} \mbox{\hyperlink{class_b_a_r_e2_d_1_1_lua_script_context_wrapper_adbedabb1bef4b251dfea089d2da0edf4}{m\_completed}};}
\DoxyCodeLine{00143     \}}
\DoxyCodeLine{00144 }
\DoxyCodeLine{00145 \} \textcolor{comment}{// namespace BARE2D}}

\end{DoxyCode}
